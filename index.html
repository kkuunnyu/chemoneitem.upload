<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>CHEMONE í’ˆëª© ì¡°íšŒ</title>
  <link rel="icon" href="C-favicon.ico" type="image/x-icon" />
  <style>
    @font-face {
      font-family: 'BladeRunner';
      src: url('blade_runner.ttf') format('truetype');
    }
    @font-face {
      font-family: 'NanumSquareNeo';
      src: url(https://hangeul.pstatic.net/hangeul_static/webfont/NanumSquareNeo/NanumSquareNeoTTF-bRg.woff) format("woff");
    }
    body {
      font-family: 'NanumSquareNeo', sans-serif;
      background-color: #f7f7f7;
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
    }
    h1 {
      text-align: center;
      font-size: 2rem;
    }
    .chemone {
      font-family: 'BladeRunner', sans-serif;
      color: #113597;
    }
    .category-info {
      background: #eef2ff;
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 6px solid #3b82f6;
      font-size: 0.95rem;
    }
    .upload-section, .search-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    input[type="file"], input[type="text"] {
      padding: 0.5rem;
      font-size: 1rem;
      min-width: 200px;
    }
    button {
      padding: 0.5rem 1rem;
      background-color: #1d4ed8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .casInputWrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    details {
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 1rem;
      padding: 0.5rem;
    }
    summary {
      font-weight: bold;
      cursor: pointer;
    }
    table.item-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.95rem;
    }
    .item-table th, .item-table td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: left;
    }
    .item-table th {
      background-color: #f1f5f9;
    }
    .red-text {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1><span class="chemone">CHEMONE</span> í’ˆëª© ì¡°íšŒ</h1>

  <div class="category-info">
    <strong>ì¹´í…Œê³ ë¦¬:</strong><br>
    â–¸ <b>CAS No.</b>, í’ˆëª©ê·¸ë£¹, í’ˆëª©ì½”ë“œ, ë¸Œëœë“œ, êµ¬ë§¤ì²˜, í’ˆëª©ëª…, í’ˆëª©ì´ìŠˆ, NCIS,<br>
    â–¸ ìœ í•´í™”í•™ë¬¼ íŒë§¤ì—…ì‹ ê³ , ìœ í•´í™”í•™ë¬¼ ì‹œì•½íŒë§¤ì—…ì‹ ê³ , ë¹„ê³ 
  </div>

  <div class="upload-section">
    <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" />
    <button onclick="downloadExcel()">ê²°ê³¼ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
    <button onclick="resetSearch()">ì´ˆê¸°í™”</button>
  </div>

  <div class="search-bar" id="searchContainer">
    <div class="casInputWrapper">
      <input type="text" class="casInput" placeholder="CAS No. ì…ë ¥" />
      <button onclick="addInput()">+</button>
    </div>
  </div>
  <button onclick="applyMultipleCASSearch()">ê²€ìƒ‰</button>

  <div id="resultsContainer"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="data.js"></script>
  <script>
    const resultsContainer = document.getElementById('resultsContainer');
    const searchContainer = document.getElementById('searchContainer');
    let filteredData = [];

    function addInput() {
      const wrapper = document.createElement('div');
      wrapper.className = 'casInputWrapper';
      wrapper.innerHTML = '<input type="text" class="casInput" placeholder="CAS No. ì…ë ¥" /> <button onclick="this.parentElement.remove()">-</button>';
      searchContainer.appendChild(wrapper);
    }

    function normalizeKey(key) {
      return key.replace(/\s+/g, '').replace(/[^a-zA-Zê°€-í£0-9]/g, '').toLowerCase();
    }

    function findKey(item, targetKey) {
      return Object.keys(item).find(k => normalizeKey(k) === normalizeKey(targetKey));
    }

    function applyMultipleCASSearch() {
      const inputs = document.querySelectorAll('.casInput');
      const keywords = Array.from(inputs).map(i => i.value.trim().toLowerCase()).filter(Boolean);

      filteredData = window.DATA.filter(item => {
        return keywords.some(kw => {
          const key = findKey(item, 'CAS No.');
          const value = key ? item[key] : '';
          return typeof value === 'string' && value.toLowerCase() === kw;
        });
      });

      renderAccordion();
    }

    function renderAccordion() {
      resultsContainer.innerHTML = '';
      if (filteredData.length === 0) {
        resultsContainer.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      const grouped = {};
      filteredData.forEach(item => {
        const casKey = findKey(item, 'CAS No.');
        const cas = casKey ? (item[casKey] || '').trim() : '[CAS í‚¤ ì—†ìŒ]';
        if (!grouped[cas]) grouped[cas] = [];
        grouped[cas].push(item);
      });

      Object.entries(grouped).forEach(([cas, items]) => {
        const hasDanger = items.some(item => {
          const fields = ['ìœ í•´í™”í•™ë¬¼ íŒë§¤ì—…ì‹ ê³ ', 'ìœ í•´í™”í•™ë¬¼ ì‹œì•½íŒë§¤ì—…ì‹ ê³ ', 'í’ˆëª©ê·¸ë£¹', 'NCIS'];
          return fields.some(field => {
            const k = findKey(item, field);
            const v = item[k] || '';
            return typeof v === 'string' && (v.includes('ìœ í•´') || v.includes('ìœ ë…'));
          });
        });

        const details = document.createElement('details');
        const summary = document.createElement('summary');
        const casDisplay = hasDanger
          ? `<span class="red-text">CAS No.: ${cas}</span>`
          : `CAS No.: ${cas}`;
        summary.innerHTML = `ğŸ“¦ ${casDisplay} <span style="color:gray;">(${items.length}ê°œ í•­ëª©)</span>`;
        details.appendChild(summary);

        const table = document.createElement('table');
        table.className = 'item-table';

        const fields = ['CAS No.', 'í’ˆëª©ê·¸ë£¹', 'í’ˆëª©ì½”ë“œ', 'ë¸Œëœë“œ', 'êµ¬ë§¤ì²˜', 'í’ˆëª©ëª…', 'í’ˆëª©ì´ìŠˆ', 'NCIS', 'ìœ í•´í™”í•™ë¬¼ íŒë§¤ì—…ì‹ ê³ ', 'ìœ í•´í™”í•™ë¬¼ ì‹œì•½íŒë§¤ì—…ì‹ ê³ ', 'ë¹„ê³ '];

        const headerRow = document.createElement('tr');
        fields.forEach(field => {
          const th = document.createElement('th');
          th.textContent = field;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);

        items.forEach(item => {
          const row = document.createElement('tr');
          fields.forEach(field => {
            const td = document.createElement('td');
            const k = findKey(item, field);
            const v = item[k] || '';
            const isDanger = ['ìœ í•´í™”í•™ë¬¼ íŒë§¤ì—…ì‹ ê³ ', 'ìœ í•´í™”í•™ë¬¼ ì‹œì•½íŒë§¤ì—…ì‹ ê³ ', 'í’ˆëª©ê·¸ë£¹', 'NCIS'].includes(field)
              && (v.includes('ìœ í•´') || v.includes('ìœ ë…'));
            td.innerHTML = isDanger ? `<span class="red-text">${v}</span>` : v;
            row.appendChild(td);
          });
          table.appendChild(row);
        });

        details.appendChild(table);
        resultsContainer.appendChild(details);
      });
    }

    document.getElementById('excelInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const casList = rows.flat().map(v => v?.toString().trim().toLowerCase()).filter(Boolean);

        filteredData = window.DATA.filter(item => {
          const casKey = findKey(item, 'CAS No.');
          const value = casKey ? item[casKey]?.toString().trim().toLowerCase() : '';
          return casList.includes(value);
        });

        renderAccordion();
      };
      reader.readAsArrayBuffer(file);
    });

    function downloadExcel() {
      if (filteredData.length === 0) {
        alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      const worksheet = XLSX.utils.json_to_sheet(filteredData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'ê²€ìƒ‰ê²°ê³¼');
      XLSX.writeFile(workbook, 'ê²€ìƒ‰ê²°ê³¼.xlsx');
    }

    function resetSearch() {
      document.getElementById('excelInput').value = '';
      document.querySelectorAll('.casInputWrapper').forEach((el, idx) => {
        if (idx === 0) el.querySelector('input').value = '';
        else el.remove();
      });
      filteredData = [];
      resultsContainer.innerHTML = '';
    }
  </script>
</body>
</html>
